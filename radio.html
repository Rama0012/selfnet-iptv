<!doctype html>
<meta charset=utf-8>
<title>SelfStreaming</title>
<link rel=stylesheet href=css/bootstrap.min.css>
<link rel=icon href=favicon.ico>
<script src=js/jquery-2.0.3.min.js></script>
<script src=js/fixencoding.js></script>
<style>
#channel-list td:nth-child(-n+2) {
	cursor: pointer;
}
</style>
<div class="container">
    <div class="page-header text-center">
        <a href=/><img src=img/selfstreaming.png alt=SelfStreaming height=58 width=382></a>
        <p class=lead>SelfStreaming also has some radio channels
    </div>

    <h2>Radio Channels</h2>
    <p>These channels are currently <strong>not</strong> announced via SAP. In most modern browsers, you should be able to play them directly, otherwise you need to open the links in your media&nbsp;player. Buffering can take a couple of seconds.
    <p><audio id=player class=center style=display:none controls></audio>
    <table id=channel-list class="table table-hover">
        <thead><tr><th>Channel<th>Current Title<th>Website<th>Stream Link
        <tbody>
    </table>
    <noscript>This website requires JavaScript.</noscript>
    <hr>
    <p>If you have any questions or suggestions, <a href=mailto:support@selfnet.de>send us an email</a>.
</div>

<script>
$(function() {
	var player = $('#player').show();
	player.on('error', function(e) {
		console.error(e);
		if (player.attr('src').match(/ogg$/)) {
			console.info('If you are using Chrome/Chromium, you may be hitting http://crbug.com/175281. For Firefox, make sure to use version 20 or newer.');
		}
	});
	$.get('radio/status.xml', function(data) {
		var doc = data.documentElement.ownerDocument;
		var sources = doc.evaluate('/icestats/source', data, null, XPathResult.UNORDERED_NODE_ITERATOR_TYPE, null);
		var source;
		function evalXPath(node, expr) {
			return doc.evaluate(expr, source, null, XPathResult.STRING_TYPE, null).stringValue;
		}
		var i = 0;
		while (source = sources.iterateNext()) {
			++i;
			var mount = evalXPath(source, '@mount');
			// only the dead can know peace from this encoding chaos
			var name = fixEncoding(evalXPath(source, 'server_name/text()'));
			var title = fixEncoding(evalXPath(source, 'title/text()'));
			var url = evalXPath(source, 'server_url/text()');
			// don't display links with no dots or links set by software defaults
			url = url.match(/^([^.]*|http:\/\/(www.shoutcast.com|savonet.sf.net))$/) ? '' : (url.match(/^http:\/\//) ? url : ('http://' + url));
			var short_url = url.substr(7);
			short_url = short_url.match(/^www\./) ? short_url.substr(4) : short_url;
			short_url = short_url.length > 21 ? (short_url.substr(0, 21-3) + '...') : short_url;
			// some stations add boilerplate copyright notices or links at the end, remove these
			name = name.replace(/(, )?(Â©|\(c\)).*$/, '').replace(/( -)? (OGG|MP3)$/, '').replace(/ - www\..+$/, '');
			// others display the mount point or default names, use the local mount point instead
			name = name.match(/^(|\/.*|Unspecified name|Unnamed Server)$/) ? mount.substr(1).replace(/\.(ogg|mp3)$/, '').split('_').join(' ') : name;
			var stream = 'radio' + mount;
			var td1 = $('<td>').text(name);
			var td2 = $('<td>').text(title);
			var td3 = $('<td>').append($('<a>').attr('href', url).text(short_url));
			var td4 = $('<td>').append($('<a>').attr('href', stream).text('Link'));
			var tr = $('<tr>').append(td1, td2, td3, td4);
			var context = {stream:stream, tr:tr};
			function clickHandler(e) {
				player.attr('src', e.data.stream).trigger('play');
				$('#channel-list tr').removeClass('active');
				e.data.tr.addClass('active');
			}
			td1.click(context, clickHandler);
			td2.click(context, clickHandler);
			$('#channel-list tbody').append(tr);
		}
		console.log('got', i, 'channels');
	}, 'xml').fail(function() {
		console.error(arguments);
	});
});
</script>
